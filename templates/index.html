<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>‡§ï‡§ø‡§∏‡§æ‡§® ‡§∏‡§≤‡§æ‡§π‡§ï‡§æ‡§∞ | Farmer Advisor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, "Helvetica Neue", Arial, sans-serif;
            padding: 0;
            margin: 0;
            background-color: #f5f5f5;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height for mobile */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            overflow-x: hidden; /* Prevent horizontal scroll */
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        /* WhatsApp-like chat header - ENLARGED */
        .chat-header {
            background-color: #075E54;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 20px;
            flex-shrink: 0;
            box-shadow: 0 3px 6px rgba(0,0,0,0.25);
            min-height: 80px;
        }
        body.dark-mode .chat-header { background-color: #0b3f39; }
        .chat-header-left { display: flex; align-items: center; gap: 14px; }
        .chat-title { font-size: 22px; font-weight: 700; line-height: 1.3; }
        .chat-subtitle { font-size: 14px; opacity: 0.9; }
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #fff;
            color: #075E54;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
            flex-shrink: 0;
        }

        /* 1. TOP NAVIGATION HEADER */
        .top-header {
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
            z-index: 100;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        body.dark-mode .top-header {
            background-color: #2d2d2d;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header-top-row {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            gap: 20px;
            border-bottom: 1px solid #e0e0e0;
            transition: border-color 0.3s ease;
        }

        body.dark-mode .header-top-row {
            border-bottom: 1px solid #444;
        }

        .hamburger-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #333;
            padding: 8px 12px;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .hamburger-btn:hover {
            background-color: #f0f0f0;
            border-radius: 5px;
        }

        body.dark-mode .hamburger-btn {
            color: #e0e0e0;
        }

        body.dark-mode .hamburger-btn:hover {
            background-color: #3d3d3d;
        }

        .header-tabs {
            display: flex;
            gap: 15px;
            flex-grow: 1;
        }

        .header-tab {
            background: none;
            border: none;
            padding: 10px 18px;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .header-tab:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        body.dark-mode .header-tab {
            color: #aaa;
        }

        body.dark-mode .header-tab:hover {
            background-color: #3d3d3d;
            color: #e0e0e0;
        }

        .header-second-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 20px;
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            color: #2e7d32;
            margin: 0;
            transition: color 0.3s ease;
        }

        body.dark-mode .app-title {
            color: #4caf50;
        }

        .language-selector-btn {
            background-color: #f0f0f0;
            border: 2px solid #ddd;
            padding: 12px 24px;
            font-size: 18px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            border-radius: 30px;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .language-selector-btn:hover {
            background-color: #e0e0e0;
        }

        body.dark-mode .language-selector-btn {
            background-color: #3d3d3d;
            border: 1px solid #555;
            color: #e0e0e0;
        }

        body.dark-mode .language-selector-btn:hover {
            background-color: #4d4d4d;
        }

        /* Dark Mode Toggle Button */
        .dark-mode-toggle {
            background-color: #f0f0f0;
            border: 2px solid #ddd;
            padding: 12px 16px;
            font-size: 28px;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.3s ease;
            margin-right: 0;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .dark-mode-toggle:hover {
            background-color: #e0e0e0;
            transform: rotate(180deg);
        }

        body.dark-mode .dark-mode-toggle {
            background-color: #3d3d3d;
            border: 1px solid #555;
        }

        body.dark-mode .dark-mode-toggle:hover {
            background-color: #4d4d4d;
        }

        /* 2. CENTRAL CHAT AREA */
        .chat-area {
            flex: 1;
            overflow-y: scroll;
            overflow-x: hidden;
            padding: 20px;
            padding-bottom: 20px;
            background-color: #ece5dd;
            background-image: radial-gradient(#d1d7db 1px, transparent 1px);
            background-size: 12px 12px;
            background-position: 0 0, 6px 6px;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
            -webkit-overflow-scrolling: touch;
            height: 0; /* Important for flex scrolling */
            min-height: 0; /* Important for flex scrolling */
        }

        /* Custom Scrollbar */
        .chat-area::-webkit-scrollbar {
            width: 12px;
        }

        .chat-area::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }

        .chat-area::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .chat-area::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        body.dark-mode .chat-area {
            background-color: #121b22;
            background-image: none;
        }

        body.dark-mode .chat-area::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        body.dark-mode .chat-area::-webkit-scrollbar-thumb {
            background: #555;
            border-color: #2d2d2d;
        }

        body.dark-mode .chat-area::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* Firefox Scrollbar */
        .chat-area {
            scrollbar-width: thin;
            scrollbar-color: #888 #e0e0e0;
        }

        body.dark-mode .chat-area {
            scrollbar-color: #555 #2d2d2d;
        }

        #chatbox {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
        }

        .msg { display: flex; margin: 6px 0; }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .msg.user { justify-content: flex-end; }
        .msg.bot { justify-content: flex-start; }

        .msg-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .msg.user .msg-avatar {
            background-color: #2e7d32;
            color: white;
        }

        .msg.bot .msg-avatar {
            background-color: #0288d1;
            color: white;
        }

        .msg-bubble {
            max-width: 80%;
            padding: 12px 14px;
            border-radius: 14px;
            line-height: 1.6;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            position: relative;
            font-size: 16px;
        }

        .msg-bubble p {
            margin: 0 0 10px 0;
        }

        .msg-bubble p:last-child {
            margin-bottom: 0;
        }

        .msg-bubble ul, .msg-bubble ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .msg-bubble li {
            margin: 5px 0;
        }

        .msg-bubble strong {
            font-weight: 600;
        }

        .msg-bubble h1, .msg-bubble h2, .msg-bubble h3, 
        .msg-bubble h4, .msg-bubble h5, .msg-bubble h6 {
            margin: 15px 0 10px 0;
            font-weight: 600;
        }

        .msg-bubble h1:first-child, .msg-bubble h2:first-child, 
        .msg-bubble h3:first-child, .msg-bubble h4:first-child {
            margin-top: 0;
        }

        .msg.user .msg-bubble { background-color: #dcf8c6; color: #111; border-top-right-radius: 2px; }
        .msg.bot .msg-bubble { background-color: #ffffff; color: #111; border-top-left-radius: 2px; }

        body.dark-mode .msg.bot .msg-bubble {
            background-color: #2d2d2d;
            color: #e0e0e0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        body.dark-mode .msg.bot .msg-bubble ul,
        body.dark-mode .msg.bot .msg-bubble ol {
            color: #e0e0e0;
        }

        body.dark-mode .msg.bot .msg-bubble strong {
            color: #4caf50;
        }

        body.dark-mode .msg.user .msg-bubble {
            background-color: #1b5e20;
        }

        .msg.error .msg-bubble { background-color: #ffdede; color: #8a0000; }

        .msg-time {
            font-size: 11px;
            opacity: 0.6;
            margin-left: 8px;
            white-space: nowrap;
            float: right;
        }

        /* 3. FLOATING INPUT BAR (Bottom Section) */
        .floating-input-container {
            position: sticky;
            bottom: 0;
            background-color: #ece5dd;
            padding: 20px;
            display: flex;
            justify-content: center;
            flex-shrink: 0;
            transition: background-color 0.3s ease;
        }

        body.dark-mode .floating-input-container {
            background-color: #1a1a1a;
        }

        .pill-input-bar {
            display: flex;
            align-items: center;
            gap: 14px;
            background-color: #ffffff;
            border: 2px solid #ddd;
            border-radius: 999px;
            padding: 14px 20px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .pill-input-bar:focus-within {
            border-color: #2e7d32;
            box-shadow: 0 4px 16px rgba(46, 125, 50, 0.2);
        }

        body.dark-mode .pill-input-bar {
            background-color: #2d2d2d;
            border: 2px solid #444;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        body.dark-mode .pill-input-bar:focus-within {
            border-color: #4caf50;
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
        }

        /* Compact image preview inside input bar */
        #imagePreviewBar {
            flex-shrink: 0;
        }

        body.dark-mode #chatImagePreview {
            border-color: #555;
        }

        #removeImageBtn:hover {
            background-color: #ff3333 !important;
            transform: scale(1.1);
        }

        body.dark-mode #removeImageBtn {
            background-color: #ff5555;
        }

        body.dark-mode #removeImageBtn:hover {
            background-color: #ff3333 !important;
        }

        /* Image in chat bubble */
        .msg-image {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 8px;
            border: 1px solid #ddd;
            cursor: pointer;
        }

        body.dark-mode .msg-image {
            border-color: #555;
        }

        .pill-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            padding: 10px;
            transition: all 0.3s ease;
            flex-shrink: 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-width: 50px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pill-btn:hover {
            color: #2e7d32;
            transform: scale(1.1);
        }

        .pill-btn:active {
            transform: scale(0.95);
        }

        body.dark-mode .pill-btn {
            color: #aaa;
        }

        body.dark-mode .pill-btn:hover {
            color: #4caf50;
        }

        .send-btn {
            background-color: #25D366 !important;
            color: white !important;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-width: 50px;
            min-height: 50px;
        }

        .send-btn:hover {
            background-color: #1b5e20 !important;
            color: white !important;
            transform: scale(1.1);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            background-color: #ccc !important;
            color: #666 !important;
            cursor: not-allowed;
            transform: none;
        }

        body.dark-mode .send-btn {
            background-color: #4caf50 !important;
        }

        body.dark-mode .send-btn:hover {
            background-color: #66bb6a !important;
        }

        #question {
            flex-grow: 1;
            border: none;
            background: none;
            font-size: 20px;
            color: #333;
            resize: none;
            min-height: 32px;
            max-height: 180px;
            overflow-y: auto;
            font-family: inherit;
            transition: color 0.3s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        #question::placeholder {
            color: #999;
        }

        #question:focus {
            outline: none;
        }

        body.dark-mode #question {
            color: #e0e0e0;
        }

        body.dark-mode #question::placeholder {
            color: #666;
        }

        .loading-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 18px;
            margin: 12px auto;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 80%;
            transition: all 0.3s ease;
            align-self: center;
            font-size: 17px;
        }

        body.dark-mode .loading-indicator {
            background-color: #2d2d2d;
            color: #e0e0e0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .voice-controls {
            display: none;
        }

        /* Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            /* Larger spinner */
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Loading Indicator */
        .loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            margin-top: 10px;
            font-size: 18px;
            color: #6c757d;
        }

        .loading-indicator .spinner {
            margin-right: 10px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            /* Darker overlay */
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: #ffffff;
            color: #333;
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            text-align: center;
            transition: all 0.3s ease;
        }

        body.dark-mode .modal-content {
            background-color: #2d2d2d;
            color: #e0e0e0;
        }

        .modal-content h2 {
            font-size: 28px;
            margin-bottom: 15px;
            color: #333;
        }

        body.dark-mode .modal-content h2 {
            color: #e0e0e0;
        }

        .modal-content p {
            font-size: 18px;
            margin-bottom: 20px;
            color: #666;
        }

        body.dark-mode .modal-content p {
            color: #aaa;
        }

        #modalLanguageSelect {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
            background-color: #f5f5f5;
            color: #333;
            transition: all 0.3s ease;
        }

        body.dark-mode #modalLanguageSelect {
            background-color: #1a1a1a;
            border: 1px solid #555;
            color: #e0e0e0;
        }

        #saveLanguageBtn {
            padding: 12px 25px;
            font-size: 18px;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        #saveLanguageBtn:hover {
            background-color: #388E3C;
        }

        /* Tablet Responsive */
        @media (max-width: 1024px) {
            .msg {
                max-width: 80%;
            }

            .msg.user {
                margin-right: 10%;
            }

            .msg.bot {
                margin-left: 10%;
            }

            /* Image preview stays compact on tablet */
            .msg-image {
                max-width: 250px !important;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                height: 100vh;
                height: 100dvh;
            }

            .chat-header {
                padding: 14px 16px;
                min-height: 68px;
            }

            .chat-header-left {
                gap: 10px;
            }

            .chat-title {
                font-size: 18px;
            }

            .chat-subtitle {
                font-size: 12px;
            }

            .chat-avatar {
                width: 42px;
                height: 42px;
                font-size: 18px;
            }

            .header-actions {
                gap: 8px;
            }

            .header-top-row {
                padding: 10px 15px;
            }

            .header-second-row {
                padding: 15px;
                flex-wrap: wrap;
            }

            .app-title {
                font-size: 18px;
                flex: 1;
            }

            .header-tabs {
                gap: 8px;
            }

            .header-tab {
                padding: 6px 10px;
                font-size: 12px;
            }

            .hamburger-btn {
                font-size: 24px;
                padding: 5px 8px;
            }

            .dark-mode-toggle {
                font-size: 24px;
                width: 48px;
                height: 48px;
                padding: 10px 12px;
            }

            .language-selector-btn {
                padding: 8px 16px;
                font-size: 15px;
            }

            .pill-btn {
                font-size: 24px;
                min-width: 44px;
                min-height: 44px;
                padding: 8px;
            }

            .chat-area {
                padding: 15px 10px;
                padding-bottom: 15px;
            }

            .chat-area::-webkit-scrollbar {
                width: 8px;
            }

            .msg {
                max-width: 90%;
                margin-left: 5%;
                margin-right: 5%;
            }

            .msg.user {
                margin-right: 5%;
            }

            .msg.bot {
                margin-left: 5%;
            }

            .msg-avatar {
                width: 32px;
                height: 32px;
                font-size: 18px;
            }

            .msg-bubble {
                padding: 10px 14px;
                font-size: 15px;
            }

            .floating-input-container {
                padding: 15px 10px;
            }

            /* Image preview stays compact on mobile */
            .msg-image {
                max-width: 200px !important;
            }

            .pill-input-bar {
                max-width: 100%;
                padding: 12px 16px;
                gap: 10px;
                border: 1px solid #ddd;
            }

            .send-btn {
                width: 44px;
                height: 44px;
                font-size: 20px;
                min-width: 44px;
                min-height: 44px;
            }

            #question {
                font-size: 17px;
                min-height: 28px;
            }

            /* Modal on mobile */
            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .modal-content h2 {
                font-size: 22px;
            }

            .modal-content p {
                font-size: 16px;
            }

            #modalLanguageSelect {
                font-size: 16px;
                padding: 10px;
            }

            #saveLanguageBtn {
                font-size: 16px;
                padding: 10px 20px;
            }
        }

        /* Small Mobile Responsive */
        @media (max-width: 480px) {
            .chat-header {
                padding: 12px 14px;
                min-height: 62px;
            }

            .chat-title {
                font-size: 16px;
            }

            .chat-subtitle {
                font-size: 11px;
            }

            .chat-avatar {
                width: 38px;
                height: 38px;
                font-size: 16px;
            }

            .app-title {
                font-size: 16px;
            }

            .header-tab {
                padding: 5px 8px;
                font-size: 11px;
            }

            .dark-mode-toggle {
                width: 44px;
                height: 44px;
                font-size: 22px;
            }

            .language-selector-btn {
                padding: 7px 14px;
                font-size: 14px;
            }

            .pill-btn {
                font-size: 22px;
                min-width: 40px;
                min-height: 40px;
            }

            .msg {
                max-width: 95%;
                margin-left: 2.5%;
                margin-right: 2.5%;
                gap: 8px;
            }

            .msg.user {
                margin-right: 2.5%;
            }

            .msg.bot {
                margin-left: 2.5%;
            }

            .msg-avatar {
                width: 28px;
                height: 28px;
                font-size: 16px;
            }

            .msg-bubble {
                padding: 9px 12px;
                font-size: 14px;
            }

            /* Image preview stays compact on small mobile */
            .msg-image {
                max-width: 180px !important;
            }

            .pill-input-bar {
                padding: 10px 14px;
                gap: 8px;
            }

            .send-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
                min-width: 40px;
                min-height: 40px;
            }

            #question {
                font-size: 16px;
                min-height: 26px;
            }

            /* Modal on small mobile */
            .modal-content {
                width: 96%;
                padding: 18px;
                max-width: none;
            }

            .modal-content h2 {
                font-size: 20px;
                margin-bottom: 12px;
            }

            .modal-content p {
                font-size: 14px;
                margin-bottom: 15px;
            }

            #modalLanguageSelect {
                font-size: 15px;
                padding: 9px;
            }

            #saveLanguageBtn {
                font-size: 15px;
                padding: 9px 18px;
            }

            /* Ensure loading indicator fits */
            .loading-indicator {
                font-size: 15px;
                padding: 14px;
                max-width: 90%;
            }
        }

        /* Large Screen Optimization */
        @media (min-width: 1440px) {
            .msg {
                max-width: 60%;
            }

            .msg.user {
                margin-right: 20%;
            }

            .msg.bot {
                margin-left: 20%;
            }

            .pill-input-bar {
                max-width: 900px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
    <div id="languageModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeLanguageModal">&times;</span>
            <h2>üåê ‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç | Select Language</h2>
            <p>‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•Ä ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç | Please select your preferred language:</p>
            <select id="modalLanguageSelect">
                <option value="english">English</option>
                <option value="hindi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
                <option value="marathi">‡§Æ‡§∞‡§æ‡§†‡•Ä</option>
                <option value="tamil">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
                <option value="telugu">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
                <option value="kannada">‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
                <option value="punjabi">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä</option>
            </select>
            <button id="saveLanguageBtn" class="btn-primary">‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç | Continue</button>
        </div>
    </div>

    <!-- Header: WhatsApp-like chat bar -->
    <div class="chat-header">
        <div class="chat-header-left">
            <div class="chat-avatar">SA</div>
            <div>
                <div class="chat-title">Sugarcane Advisor</div>
                <div class="chat-subtitle">Farmer support ‚Ä¢ India</div>
            </div>
        </div>
        <div class="header-actions">
            <button class="pill-btn" id="helpBtn" title="Help / Tips">‚ùì</button>
            <button class="dark-mode-toggle" id="darkModeToggle" title="Toggle Dark Mode">üåô</button>
            <button class="language-selector-btn" id="switchLanguageBtn" title="Language">üåê</button>
        </div>
    </div>

    <!-- 2. CENTRAL CHAT AREA -->
    <div class="chat-area">
        <div id="chatbox"></div>
        <div id="loadingIndicator" class="loading-indicator" style="display:none;">
            <span class="spinner"></span>
            <span>Thinking...</span>
        </div>

    </div>

    <!-- 3. FLOATING INPUT BAR -->
    <div class="floating-input-container">
        <div class="pill-input-bar">
            <label for="chatImageInput" class="pill-btn" title="Attach Image">
                <input type="file" id="chatImageInput" accept="image/*" style="display:none;">
                üì∑
            </label>
            <label for="chatFileInput" class="pill-btn" title="Upload Document">
                <input type="file" id="chatFileInput" name="files" accept=".pdf,.txt,.doc,.docx" style="display:none;">
                üìé
            </label>
            <!-- Compact image preview inside input bar -->
            <div id="imagePreviewBar" style="display:none; position:relative;">
                <img id="chatImagePreview" src="" alt="Preview" style="width:36px; height:36px; object-fit:cover; border-radius:6px; border:2px solid #ddd; cursor:pointer;" title="Click to view">
                <button id="removeImageBtn" style="position:absolute; top:-6px; right:-6px; background:#ff5555; color:#fff; border:none; width:18px; height:18px; border-radius:50%; font-size:12px; line-height:1; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0; box-shadow:0 2px 4px rgba(0,0,0,0.2);" title="Remove image">√ó</button>
            </div>
            <textarea id="question" placeholder="Ask your question..." maxlength="5000" rows="1"></textarea>
            <button type="button" id="voiceBtn" class="pill-btn" title="Voice Input">üé§</button>
            <button type="button" id="sendBtn" class="pill-btn send-btn" title="Send Message">‚û§</button>
        </div>
    </div>

    <!-- Hidden elements -->
    <div class="voice-controls">
        <button type="button" id="speakBtn" class="voice-btn btn-secondary">üîä Listen to Answer</button>
        <button type="button" id="stopSpeakBtn" class="voice-btn btn-danger" style="display:none;">‚èπÔ∏è Stop</button>
    </div>

    <script>
        // Utility: Add message to chat
        function addMessage(message, sender, imageData = null) {
            const chatbox = document.getElementById('chatbox');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'msg ' + (sender || 'bot');

            const bubble = document.createElement('div');
            bubble.className = 'msg-bubble';

            let content = '';
            if (sender === 'user') {
                content = escapeHtml(message);
                if (imageData) {
                    content = `<img src="${imageData}" class="msg-image" style="max-width:300px; display:block;" alt="Attached image"><div style="margin-top:8px;">${content}</div>`;
                }
                bubble.innerHTML = `${content} <span class="msg-time">${formatTime()}</span>`;
            } else if (sender === 'bot') {
                bubble.innerHTML = `${marked.parse(message)} <span class="msg-time">${formatTime()}</span>`;
            } else if (sender === 'error') {
                bubble.innerHTML = `${escapeHtml(message)} <span class="msg-time">${formatTime()}</span>`;
            }

            msgDiv.appendChild(bubble);
            chatbox.appendChild(msgDiv);

            // Smooth scroll to bottom
            chatbox.parentElement.scrollTop = chatbox.parentElement.scrollHeight;
        }

        function formatTime(d=new Date()) {
            try {
                return d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            } catch { return ''; }
        }

        // Utility: Escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Utility: Show loading
        function showLoading() {
            document.getElementById('loadingIndicator').style.display = '';
        }
        // Utility: Hide loading
        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }
        // Utility: Get language
        function getLanguage() {
            return localStorage.getItem('appLanguage') || 'english';
        }

        // Variables
        let recognition;
        let synthesis = window.speechSynthesis;
        let currentUtterance = null;
        let lastBotMessage = '';
        let currentLanguage = localStorage.getItem('appLanguage') || 'english'; // Default to English
        let attachedImageFile = null; // Store attached image

        const languageCodes = {
            'english': 'en-US',
            'hindi': 'hi-IN',
            'marathi': 'mr-IN',
            'tamil': 'ta-IN',
            'telugu': 'te-IN',
            'kannada': 'kn-IN',
            'punjabi': 'pa-IN'
        };

        const translations = {
            'english': {
                'appTitle': 'Farmer Agricultural Advisor',
                'appTagline': 'Expert Advice for Sugarcane Farming',
                'selectLanguage': 'Select Language:',
                'uploadDocuments': 'Upload Documents',
                'maxFileSize': 'Max 50MB per file | PDF, TXT, DOC, DOCX allowed',
                'uploadFiles': 'Upload Files',
                'cropDiseaseId': 'Crop Disease Identification',
                'uploadCropPhoto': 'Upload crop photo | JPG, JPEG, PNG (max 10MB)',
                'analyzeImage': 'Analyze Image',
                'askQuestion': 'Ask your question...',
                'voiceInput': 'Voice Input',
                'send': 'Send',
                'listenAnswer': 'Listen to Answer',
                'stopSpeaking': 'Stop Speaking',
                'thinking': 'Thinking...',
                'you': 'You:',
                'advisor': 'Advisor:',
                'error': 'Error:',
                'noFilesSelected': 'Please select at least one file',
                'uploading': 'Uploading...',
                'networkError': 'Network error:',
                'noImageSelected': 'Please select a crop image',
                'analyzing': 'Analyzing...',
                'voiceNotSupported': 'Voice input not supported in this browser',
                'voiceError': 'Voice recognition error:',
                'noMessageToRead': 'No message to read',
                'loadedFiles': 'Loaded Files',
                'noFilesLoaded': 'No files loaded.',
                'newChat': 'New Chat',
                'searchChat': 'Search Chat',
                'resetChat': 'Reset Chat',
                'continue': 'Continue',
                'library': 'Library',
                'projects': 'Projects',
                'explore': 'Explore',
                'uploadDocument': 'Upload Document'
            },
            'hindi': {
                'appTitle': '‡§ï‡§ø‡§∏‡§æ‡§® ‡§ï‡•É‡§∑‡§ø ‡§∏‡§≤‡§æ‡§π‡§ï‡§æ‡§∞',
                'appTagline': '‡§ó‡§®‡•ç‡§®‡•á ‡§ï‡•Ä ‡§ñ‡•á‡§§‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§∏‡§≤‡§æ‡§π',
                'selectLanguage': '‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç:',
                'uploadDocuments': '‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç',
                'maxFileSize': '‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ 50MB ‡§™‡•ç‡§∞‡§§‡§ø ‡§´‡§º‡§æ‡§á‡§≤ | PDF, TXT, DOC, DOCX ‡§Ö‡§®‡•Å‡§Æ‡§§',
                'uploadFiles': '‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç',
                'cropDiseaseId': '‡§´‡§∏‡§≤ ‡§∞‡•ã‡§ó ‡§™‡§π‡§ö‡§æ‡§®',
                'uploadCropPhoto': '‡§´‡§∏‡§≤ ‡§ï‡•Ä ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç | JPG, JPEG, PNG (‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ 10MB)',
                'analyzeImage': '‡§´‡•ã‡§ü‡•ã ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç',
                'askQuestion': '‡§Ö‡§™‡§®‡§æ ‡§∏‡§µ‡§æ‡§≤ ‡§™‡•Ç‡§õ‡•á‡§Ç...',
                'voiceInput': '‡§µ‡•â‡§Ø‡§∏ ‡§á‡§®‡§™‡•Å‡§ü',
                'send': '‡§≠‡•á‡§ú‡•á‡§Ç',
                'listenAnswer': '‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡•Å‡§®‡•á‡§Ç',
                'stopSpeaking': '‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç',
                'thinking': '‡§∏‡•ã‡§ö ‡§∞‡§π‡§æ ‡§π‡•à...',
                'you': '‡§Ü‡§™:',
                'advisor': '‡§∏‡§≤‡§æ‡§π‡§ï‡§æ‡§∞:',
                'error': '‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:',
                'noFilesSelected': '‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç',
                'uploading': '‡§Ö‡§™‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...',
                'networkError': '‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:',
                'noImageSelected': '‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡§∏‡§≤ ‡§ï‡•Ä ‡§´‡•ã‡§ü‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç',
                'analyzing': '‡§ú‡§æ‡§Ç‡§ö ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...',
                'voiceNotSupported': '‡§á‡§∏ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç ‡§µ‡•â‡§Ø‡§∏ ‡§á‡§®‡§™‡•Å‡§ü ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à',
                'voiceError': '‡§µ‡•â‡§Ø‡§∏ ‡§∞‡§ø‡§ï‡•â‡§ó‡•ç‡§®‡§ø‡§∂‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:',
                'noMessageToRead': '‡§™‡§¢‡§º‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§®‡§π‡•Ä‡§Ç',
                'loadedFiles': '‡§≤‡•ã‡§° ‡§ï‡•Ä ‡§ó‡§à ‡§´‡§º‡§æ‡§á‡§≤‡•á‡§Ç',
                'noFilesLoaded': '‡§ï‡•ã‡§à ‡§´‡§º‡§æ‡§á‡§≤ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§à‡•§',
                'newChat': '‡§®‡§à ‡§ö‡•à‡§ü',
                'searchChat': '‡§ö‡•à‡§ü ‡§ñ‡•ã‡§ú‡•á‡§Ç',
                'resetChat': '‡§ö‡•à‡§ü ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç',
                'continue': '‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç',
                'library': '‡§≤‡§æ‡§á‡§¨‡•ç‡§∞‡•á‡§∞‡•Ä',
                'projects': '‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç',
                'explore': '‡§è‡§ï‡•ç‡§∏‡§™‡•ç‡§≤‡•ã‡§∞ ‡§ï‡§∞‡•á‡§Ç',
                'uploadDocument': '‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç'
            }
            // ... add other languages here
        };

        // Utility: Clear chat
        function clearChat() {
            document.getElementById('chatbox').innerHTML = '';
        }

        // Dark Mode Toggle
        function toggleDarkMode() {
            const body = document.body;
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            body.classList.toggle('dark-mode');
            
            // Update toggle icon
            if (body.classList.contains('dark-mode')) {
                darkModeToggle.textContent = '‚òÄÔ∏è';
                localStorage.setItem('darkMode', 'enabled');
            } else {
                darkModeToggle.textContent = 'üåô';
                localStorage.setItem('darkMode', 'disabled');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initSpeechRecognition();
            updateVoiceAvailability();
            window.addEventListener('online', updateVoiceAvailability);
            window.addEventListener('offline', updateVoiceAvailability);

            // Load dark mode preference
            const darkModePreference = localStorage.getItem('darkMode');
            if (darkModePreference === 'enabled') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').textContent = '‚òÄÔ∏è';
            }

            // Show language modal if no language is set
            if (!localStorage.getItem('appLanguage')) {
                document.getElementById('languageModal').classList.add('show');
            } else {
                applyLanguage(currentLanguage);
            }

            // Show walkthrough on every page load
            showWalkthrough();

            // Auto-expand textarea
            const textarea = document.getElementById('question');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Submit on Enter (without Shift)
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });
        });

        // Send Button
        document.getElementById('sendBtn').addEventListener('click', handleSendMessage);

    // Dark Mode Toggle Button
        document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

    // Help / Tips Button
    document.getElementById('helpBtn').addEventListener('click', () => showWalkthrough(true));

        // Image and document uploads handled via buttons in input bar

        // Chat Image Input - attach image for analysis
        document.getElementById('chatImageInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                addMessage('Please select a valid image file (JPG, PNG)', 'error');
                return;
            }

            attachedImageFile = file;
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('chatImagePreview').src = ev.target.result;
                document.getElementById('chatImageName').textContent = file.name;
                document.getElementById('chatImageSize').textContent = `${(file.size/1024/1024).toFixed(2)} MB`;
                document.getElementById('imagePreviewBar').style.display = 'block';
                // Focus on question input
                document.getElementById('question').focus();
                document.getElementById('question').placeholder = 'Ask about this image...';
            };
            reader.readAsDataURL(file);
        });

        // Remove attached image
        document.getElementById('removeImageBtn').addEventListener('click', () => {
            attachedImageFile = null;
            document.getElementById('chatImageInput').value = '';
            document.getElementById('imagePreviewBar').style.display = 'none';
            document.getElementById('question').placeholder = 'Ask your question...';
        });

        // Header Upload Button (now part of left sidebar)
        // document.getElementById('headerUploadBtn').addEventListener('click', () => {
        //     document.getElementById('fileInput').click(); // Trigger the hidden file input
        // });

        // Chat File Input (next to typing box)
        document.getElementById('chatFileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const chatFileInputLabel = document.querySelector('label[for="chatFileInput"]');
            chatFileInputLabel.disabled = true;
            chatFileInputLabel.innerHTML = '<span class="spinner"></span>';

            try {
                const formData = new FormData();
                formData.append('files', file);

                const res = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await res.json();

                if (!res.ok) {
                    showAlert(data.error || 'Upload failed', 'error');
                } else {
                    showAlert(data.message, 'success');
                    // Add file to sidebar list
                    addLoadedFile(file.name);
                    document.getElementById('chatFileInput').value = ''; // Clear input
                }
            } catch (error) {
                showAlert('Network error: ' + error.message, 'error');
                console.error('Upload error:', error);
            } finally {
                chatFileInputLabel.disabled = false;
                chatFileInputLabel.innerHTML = 'ÔøΩ';
            }
        });


        // Plant Classification - Sugarcane vs Weed Detection
        document.getElementById('classifyPlantBtn').addEventListener('click', () => {
            document.getElementById('classifyPlantInput').click();
        });

        document.getElementById('classifyPlantInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                addMessage('‚ùå Please select a valid image file (JPG, PNG)', 'bot');
                return;
            }

            // Show the image in chat as user message
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const imageDataURL = ev.target.result;
                addMessage('üåø Please identify this plant: Is it sugarcane or weed?', 'user', imageDataURL);

                // Show loading indicator
                document.getElementById('loadingIndicator').style.display = 'flex';

                try {
                    const formData = new FormData();
                    formData.append('image', file);
                    formData.append('language', getLanguage());

                    const response = await fetch('/classify-plant', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        addMessage(`‚ùå Error: ${data.error || 'Classification failed'}`, 'bot');
                        return;
                    }

                    // Format the classification result
                    const classification = data.classification.toUpperCase();
                    const confidence = (data.confidence * 100).toFixed(1);
                    
                    let emoji = '‚ùì';
                    let colorClass = '';
                    if (classification === 'SUGARCANE') {
                        emoji = '‚úÖüåæ';
                        colorClass = 'success';
                    } else if (classification === 'WEED') {
                        emoji = '‚ö†Ô∏èüåø';
                        colorClass = 'warning';
                    }

                    let resultMessage = `${emoji} **Classification Result**\n\n`;
                    resultMessage += `**Type:** ${classification}\n`;
                    resultMessage += `**Confidence:** ${confidence}%\n`;
                    
                    if (data.plant_type && data.plant_type !== 'Unknown') {
                        resultMessage += `**Plant Type:** ${data.plant_type}\n`;
                    }
                    
                    resultMessage += `\n**Details:** ${data.details}\n`;
                    
                    if (data.characteristics) {
                        resultMessage += `\n**Characteristics:** ${data.characteristics}\n`;
                    }
                    
                    if (data.recommendation) {
                        resultMessage += `\n**üí° Recommendation:** ${data.recommendation}`;
                    }

                    addMessage(resultMessage, 'bot');

                } catch (error) {
                    console.error('Classification error:', error);
                    addMessage(`‚ùå Network error: ${error.message}`, 'bot');
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                    // Clear the file input for next use
                    document.getElementById('classifyPlantInput').value = '';
                }
            };
            reader.readAsDataURL(file);
        });
        function addLoadedFile(filename) {
            const loadedFilesList = document.getElementById('loadedFilesList');
            // Remove "No files loaded." if present
            const noFilesMsg = loadedFilesList.querySelector('p');
            if (noFilesMsg) {
                noFilesMsg.remove();
            }
            const fileItem = document.createElement('div');
            fileItem.className = 'loaded-file-item';
            fileItem.textContent = filename;
            loadedFilesList.appendChild(fileItem);
        }

        function showWalkthrough(force=false) {
            // If chat already has content and not forced, do nothing
            const chatbox = document.getElementById('chatbox');
            if (chatbox.children.length > 0 && !force) return;

            addMessage('üëã Welcome! Here\'s how to use Sugarcane Advisor:', 'bot');
            addMessage('**Quick Start:**\n- Type your question below and press Send ‚û§\n- Tap üì∑ to attach & analyze crop images (with your question)\n- Tap üìé to upload documents for better context\n- Use üåê to switch language ‚Ä¢ üåô for dark mode ‚Ä¢ üé§ for voice input', 'bot');
            addMessage('üí° **Tip:** You can ask in Hindi, Marathi, Tamil, Telugu, Kannada, or English.', 'bot');
        }

        // Language modal (now triggered by switchLanguageBtn)
        // document.getElementById('languageSelect').addEventListener('change', () => {
        //     const selectedLang = getLanguage();
        //     const modalLangSelect = document.getElementById('modalLanguageSelect');

        //     // Set the modal language selector to the current language
        //     modalLangSelect.value = selectedLang;

        //     // Show the language modal
        //     document.getElementById('languageModal').style.display = 'block';
        // });

        // document.getElementById('closeLanguageModal').addEventListener('click', () => {
        //     document.getElementById('languageModal').style.display = 'none';
        // });

        // document.getElementById('saveLanguageBtn').addEventListener('click', () => {
        //     const modalLangSelect = document.getElementById('modalLanguageSelect');
        //     const newLang = modalLangSelect.value;

        //     // Update the main language selector
        //     document.getElementById('languageSelect').value = newLang;

        //     // Close the modal
        //     document.getElementById('languageModal').style.display = 'none';

        //     // Optionally, you can trigger a change event if needed
        //     // document.getElementById('languageSelect').dispatchEvent(new Event('change'));
        // });

        // Switch Language button
        document.getElementById('switchLanguageBtn').addEventListener('click', () => {
            document.getElementById('modalLanguageSelect').value = currentLanguage;
            document.getElementById('languageModal').classList.add('show');
        });

        document.getElementById('closeLanguageModal').addEventListener('click', () => {
            document.getElementById('languageModal').classList.remove('show');
        });

        document.getElementById('saveLanguageBtn').addEventListener('click', () => {
            const selectedLang = document.getElementById('modalLanguageSelect').value;
            localStorage.setItem('appLanguage', selectedLang);
            currentLanguage = selectedLang;
            applyLanguage(currentLanguage);
            document.getElementById('languageModal').classList.remove('show'); // Use classList for consistency
        });

        // Image functionality now integrated into main chat flow

        function applyLanguage(lang) {
            const t = translations[lang] || translations['english'];
            // Update input area
            document.getElementById('question').placeholder = t.askQuestion;
            document.querySelector('label[for="chatFileInput"]').title = t.uploadDocument || 'Upload';
            document.getElementById('voiceBtn').title = t.voiceInput || 'Voice';
            // Update loading indicator
            document.querySelector('#loadingIndicator span:last-child').textContent = t.thinking;
            // Update modal button
            document.getElementById('saveLanguageBtn').textContent = t.continue;
        }

        // Chat handler - trigger from Enter key or send button
        async function handleSendMessage() {
            console.log('Send message triggered');
            const questionInput = document.getElementById('question');
            const sendBtn = document.getElementById('sendBtn');
            const question = questionInput.value.trim();

            // Check if we have an image attached
            const hasImage = attachedImageFile !== null;

            if (!question && !hasImage) {
                console.log('Question and image are empty');
                return;
            }

            // Save image data URL for display in chat
            let imageDataURL = null;
            if (hasImage) {
                imageDataURL = document.getElementById('chatImagePreview').src;
            }

            // Add user message with image to chat
            addMessage(question || 'Analyze this image', 'user', imageDataURL);
            questionInput.value = '';
            questionInput.style.height = 'auto';

            // Disable send button while processing
            sendBtn.disabled = true;
            showLoading();

            try {
                const lang = getLanguage();

                // If image is attached, use /scan-image endpoint
                if (hasImage) {
                    console.log('Sending image to /scan-image endpoint');
                    const formData = new FormData();
                    formData.append('file', attachedImageFile);
                    formData.append('language', lang);
                    if (question) {
                        formData.append('prompt', question);
                    }

                    const res = await fetch('/scan-image', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await res.json();
                    console.log('Response from /scan-image endpoint', data);

                    if (!res.ok) {
                        addMessage(data.error || 'Failed to analyze image', 'error');
                    } else {
                        // Format the structured response
                        let response = `**Image Analysis**\n\n`;
                        if (data.summary) response += `üìã **Summary:** ${data.summary}\n\n`;
                        if (data.severity) response += `‚ö†Ô∏è **Severity:** ${data.severity}\n\n`;
                        if (data.diagnosis && data.diagnosis.length > 0) {
                            response += `üîç **Diagnosis:**\n${data.diagnosis.map(d => `- ${d}`).join('\n')}\n\n`;
                        }
                        if (data.recommendations && data.recommendations.length > 0) {
                            response += `üíä **Recommendations:**\n${data.recommendations.map(r => `- ${r}`).join('\n')}\n\n`;
                        }
                        if (data.preventive_measures && data.preventive_measures.length > 0) {
                            response += `üõ°Ô∏è **Preventive Measures:**\n${data.preventive_measures.map(p => `- ${p}`).join('\n')}`;
                        }

                        addMessage(response, 'bot');
                        lastBotMessage = response;
                    }

                    // Clear attached image
                    attachedImageFile = null;
                    document.getElementById('chatImageInput').value = '';
                    document.getElementById('imagePreviewBar').style.display = 'none';
                    document.getElementById('question').placeholder = 'Ask your question...';

                } else {
                    // Regular text question
                    console.log('Sending question to /ask endpoint', { question, language: lang });
                    const res = await fetch('/ask', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            question: question,
                            language: lang
                        })
                    });

                    const data = await res.json();
                    console.log('Response from /ask endpoint', data);

                    if (!res.ok) {
                        addMessage(data.error || 'Failed to get response', 'error');
                    } else {
                        addMessage(data.response, 'bot');
                        lastBotMessage = data.response;
                    }
                }
            } catch (error) {
                console.error('Error in fetch:', error);
                addMessage('Network error: ' + error.message, 'error');
            } finally {
                hideLoading();
                sendBtn.disabled = false;
            }
        }

        // Voice Recognition Setup
        let isListening = false;
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.onstart = () => {
                    isListening = true;
                    const voiceBtn = document.getElementById('voiceBtn');
                    voiceBtn.textContent = 'üî¥';
                    voiceBtn.title = 'Listening... (tap to stop)';
                    console.log('Voice recognition started');
                };

                recognition.onend = () => {
                    isListening = false;
                    const voiceBtn = document.getElementById('voiceBtn');
                    voiceBtn.textContent = 'üé§';
                    voiceBtn.title = 'Voice Input';
                    console.log('Voice recognition ended');
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    console.log('Voice transcript:', transcript);
                    document.getElementById('question').value = transcript;
                    // Auto-focus and expand textarea
                    const textarea = document.getElementById('question');
                    textarea.focus();
                    textarea.style.height = 'auto';
                    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
                };

                recognition.onerror = (event) => {
                    console.error('Voice recognition error:', event.error, event);
                    isListening = false;
                    const voiceBtn = document.getElementById('voiceBtn');
                    voiceBtn.textContent = 'üé§';
                    voiceBtn.title = 'Voice Input';
                    
                    const friendly = getFriendlyVoiceError(event.error);
                    addMessage(friendly, 'error');
                };

                // Voice Button
                document.getElementById('voiceBtn').addEventListener('click', () => {
                    // Stop if already listening
                    if (isListening) {
                        try {
                            recognition.stop();
                        } catch (e) {
                            console.warn('Stop failed', e);
                        }
                        return;
                    }

                    // Check online status
                    if (!navigator.onLine) {
                        addMessage('Voice needs internet connection. You appear to be offline.', 'error');
                        return;
                    }

                    // Check if browser supports speech recognition
                    if (!recognition) {
                        addMessage('Voice input not supported in this browser. Try Chrome or Edge.', 'error');
                        return;
                    }

                    // Set language and start
                    const lang = languageCodes[getLanguage()] || 'en-US';
                    recognition.lang = lang;
                    console.log('Starting voice recognition with language:', lang);
                    
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error('Recognition start failed', e);
                        if (e.name === 'InvalidStateError') {
                            // Already running, try to stop and restart
                            recognition.stop();
                            setTimeout(() => {
                                try { recognition.start(); } catch (e2) { 
                                    addMessage('Voice recognition failed to start. Please try again.', 'error');
                                }
                            }, 100);
                        } else {
                            addMessage('Could not start voice recognition: ' + e.message, 'error');
                        }
                    }
                });
            } else {
                console.warn('Speech recognition not supported in this browser');
                // Disable voice button
                const voiceBtn = document.getElementById('voiceBtn');
                if (voiceBtn) {
                    voiceBtn.disabled = true;
                    voiceBtn.title = 'Voice input not supported in this browser';
                }
            }
        }

        function getFriendlyVoiceError(code) {
            const map = {
                'network': 'üåê Voice service needs internet. Check your connection and try again. (Tip: Voice recognition requires an active internet connection)',
                'no-speech': 'ü§´ No speech detected. Speak clearly into your microphone and try again.',
                'audio-capture': 'üé§ No microphone found. Please connect a microphone or enable microphone access.',
                'not-allowed': 'üö´ Microphone blocked. Allow microphone access in your browser settings (usually a üé§ icon in the address bar).',
                'service-not-allowed': '‚õî Voice service blocked by browser. Check site permissions in your browser settings.',
                'aborted': '‚èπÔ∏è Voice input cancelled. Tap the mic button to try again.',
                'language-not-supported': 'üåç Voice recognition doesn\'t support this language. Try switching to English, Hindi, or another supported language.'
            };
            return map[code] || ('‚ö†Ô∏è Voice recognition error: ' + code + '. Please try again.');
        }

        function updateVoiceAvailability() {
            const btn = document.getElementById('voiceBtn');
            const supported = ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window);
            const online = navigator.onLine;
            btn.disabled = !(supported && online);
            btn.setAttribute('aria-disabled', String(btn.disabled));
            btn.title = btn.disabled ? (supported ? 'Voice needs internet connection' : 'Voice input not supported on this browser') : 'Voice Input';
        }

        // Text-to-Speech
        document.getElementById('speakBtn').addEventListener('click', () => {
            if (!lastBotMessage) {
                alert('No message to read');
                return;
            }

            if (synthesis.speaking) {
                synthesis.cancel();
            }

            const lang = languageCodes[getLanguage()] || 'en-US';
            currentUtterance = new SpeechSynthesisUtterance(lastBotMessage);
            currentUtterance.lang = lang;
            synthesis.speak(currentUtterance);

            document.getElementById('speakBtn').style.display = 'none';
            document.getElementById('stopSpeakBtn').style.display = 'inline-block';
        });

        document.getElementById('stopSpeakBtn').addEventListener('click', () => {
            if (synthesis.speaking) {
                synthesis.cancel();
            }
            document.getElementById('speakBtn').style.display = 'inline-block';
            document.getElementById('stopSpeakBtn').style.display = 'none';
        });
    </script>
</body>

</html>